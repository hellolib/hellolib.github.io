(window.webpackJsonp=window.webpackJsonp||[]).push([[202],{522:function(s,t,a){"use strict";a.r(t);var e=a(3),n=Object(e.a)({},(function(){var s=this,t=s._self._c;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("h2",{attrs:{id:"什么是etcd"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#什么是etcd"}},[s._v("#")]),s._v(" 什么是ETCD")]),s._v(" "),t("blockquote",[t("p",[s._v("etcd是一个Go言编写的分布式、高可用的一致性键值存储系统，用于提供可靠的分布式键值存储、配置共享和服务发现等功能。")])]),s._v(" "),t("ul",[t("li",[t("p",[s._v("简单：")]),s._v(" "),t("ul",[t("li",[t("p",[s._v("易使用：基于HTTP+JSON的API让你用curl就可以轻松使用；")])]),s._v(" "),t("li",[t("p",[s._v("易部署：使用Go语言编写，跨平台，部署和维护简单。")])])])]),s._v(" "),t("li",[t("p",[s._v("可靠：")]),s._v(" "),t("ul",[t("li",[s._v("强一致：使用Raft算法充分保证了分布式系统数据的强一致性；")]),s._v(" "),t("li",[s._v("高可用：具有容错能力，假设集群有n个节点，当有(n-1)/2节点发送故障，依然能提供服务；")]),s._v(" "),t("li",[s._v("持久化：数据更新后，会通过WAL格式数据持久化到磁盘，支持Snapshot快照。")])])]),s._v(" "),t("li",[t("p",[s._v("快速：每个实例每秒支持一千次写操作，极限写性能可达10K QPS。")])]),s._v(" "),t("li",[t("p",[s._v("安全：可选SSL客户认证机制。")])])]),s._v(" "),t("h2",{attrs:{id:"整体框架"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#整体框架"}},[s._v("#")]),s._v(" "),t("strong",[s._v("整体框架")])]),s._v(" "),t("ul",[t("li",[s._v("HTTP Server：用于处理用户发送的API请求以及其它etcd节点的同步与心跳信息请求。")]),s._v(" "),t("li",[s._v("Store：用于处理etcd支持的各类功能的事务，包括数据索引、节点状态变更、监控与反馈、事件处理与执行等等，是etcd对用户提供的大多数API功能的具体实现。")]),s._v(" "),t("li",[s._v("Raft：Raft强一致性算法的具体实现，是etcd的核心。")]),s._v(" "),t("li",[s._v("WAL：Write Ahead Log（预写式日志），是etcd的数据存储方式。除了在内存中存有所有数据的状态以及节点的索引以外，etcd就通过WAL进行持久化存储。WAL中，所有的数据提交前都会事先记录日志。Snapshot是为了防止数据过多而进行的状态快照；Entry表示存储的具体日志内容。")])]),s._v(" "),t("p",[t("img",{attrs:{src:"https://raw.githubusercontent.com/hellolib/pictures/main/Typora/pic-00-gitee/20220706221408.png",alt:"image-20220706221408941"}})]),s._v(" "),t("h2",{attrs:{id:"常见应用场景"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#常见应用场景"}},[s._v("#")]),s._v(" 常见应用场景")]),s._v(" "),t("p",[t("strong",[s._v("1. 配置中心")])]),s._v(" "),t("ul",[t("li",[s._v("etcd是一个分布式的键值存储系统，其优秀的读写性能、一致性和可用性的机制，非常适合用来做配置中心角色。")])]),s._v(" "),t("p",[t("strong",[s._v("2. 分布式锁")])]),s._v(" "),t("ul",[t("li",[s._v("etcd的强一致性保证，可以用来做分布式场景下的同步机制保证。")])]),s._v(" "),t("p",[t("strong",[s._v("3. leader选举组件")])]),s._v(" "),t("ul",[t("li",[s._v("分布式场景下，常采用leader-follower模式来保证有状态服务的高可用（即使leader挂掉，其他follower立马补上），比如k8s和kafka partition高可用机制。可以很方便的借助etcd来实现leader选举机制，这里有个leader election实现："),t("a",{attrs:{href:"https://link.zhihu.com/?target=https%3A//github.com/willstudy/leaderelection",target:"_blank",rel:"noopener noreferrer"}},[s._v("https://github.com/willstudy/leaderelection"),t("OutboundLink")],1)])]),s._v(" "),t("p",[t("strong",[s._v("4. 服务注册与服务发现")])]),s._v(" "),t("ul",[t("li",[s._v("为了解决微服务场景下，服务地址的注册和发现问题。和配置中心功能类似，不同之处在于服务注册和服务发现，还伴随着状态检测。")])]),s._v(" "),t("p",[t("strong",[s._v("5. 消息订阅和发布")])]),s._v(" "),t("ul",[t("li",[s._v("etcd内置watch机制，完全可以实现一个小型的消息订阅和发布组件。")])]),s._v(" "),t("h2",{attrs:{id:"简单操作"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#简单操作"}},[s._v("#")]),s._v(" 简单操作")]),s._v(" "),t("h3",{attrs:{id:"_1-curd"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-curd"}},[s._v("#")]),s._v(" 1. curd")]),s._v(" "),t("p",[s._v("最常见的就是put、get和del命令。")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 放入一个 键值对")]),s._v("\n~  etcdctl put "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"name"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"zyq1"')]),s._v("\nOK\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#取出一个 键值对")]),s._v("\n~  etcdctl get  "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"name"')]),s._v("\nname\nzyq1\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 删除一个 键值对")]),s._v("\n~  etcdctl del  "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"name"')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br")])]),t("h3",{attrs:{id:"_2-watch"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-watch"}},[s._v("#")]),s._v(" 2.watch")]),s._v(" "),t("p",[s._v("watch命令用来监测key的变化，会建立长连接，一直监听。")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v(" ~  etcdctl "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("watch")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"name"')]),s._v("\nPUT\nname\nzyq1\nDELETE\nname\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br")])]),t("h3",{attrs:{id:"_3-租约"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-租约"}},[s._v("#")]),s._v(" 3. 租约")]),s._v(" "),t("p",[s._v("租约是一段时间，可以为etcd的key授予租约。当key被附加到租约时，它的生存时间被绑定到租约的生存时间，一旦租约的TTL到期，租约就过期并且所有附带的key都将被删除。")]),s._v(" "),t("p",[s._v("一个租约可以绑定不止一个key。")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 创建一个20s的租约")]),s._v("\n$ ./etcdctl lease grant "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("20")]),s._v("\nlease 694d673115905e37 granted with TTL"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("20s"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 使用租约的 id 进行 put 操作")]),s._v("\n$ ./etcdctl put --lease"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("694d673115905e37 "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"name"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"zyq"')]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 20s后get发现 key被删除了")]),s._v("\n$ ./etcdctl get "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"name"')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 空应答")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br")])]),t("p",[s._v("租约可以被删除")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 创建一个20s的租约")]),s._v("\n$ ./etcdctl lease grant "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1000")]),s._v("\nlease 694d673115905e49 granted with TTL"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("1000s"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 使用租约的 id 进行 put 操作")]),s._v("\n$ ./etcdctl put --lease"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("694d673115905e49 "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"name"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"zyq"')]),s._v("\nOK\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 删除租约")]),s._v("\n$ ./etcdctl lease revoke 694d673115905e49\nlease 694d673115905e49 revoked\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 发现key也被删除了")]),s._v("\n$ ./etcdctl get "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"name"')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 空应答")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br")])]),t("p",[s._v("租约可以自动续租")]),s._v(" "),t("div",{staticClass:"language-python line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-python"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 创建一个20s的租约")]),s._v("\n$ "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("etcdctl lease grant "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("20")]),s._v("\nlease 694d673115905e4f granted "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("with")]),s._v(" TTL"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("20s"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 自动续租")]),s._v("\n$ "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("etcdctl lease keep"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("alive 694d673115905e4f\nlease 694d673115905e4f keepalived "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("with")]),s._v(" TTL"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("20")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nlease 694d673115905e4f keepalived "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("with")]),s._v(" TTL"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("20")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br")])])])}),[],!1,null,null,null);t.default=n.exports}}]);