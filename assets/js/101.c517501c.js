(window.webpackJsonp=window.webpackJsonp||[]).push([[101],{422:function(t,s,a){"use strict";a.r(s);var n=a(3),e=Object(n.a)({},(function(){var t=this,s=t._self._c;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("h2",{attrs:{id:"pprof简介"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#pprof简介"}},[t._v("#")]),t._v(" pprof简介")]),t._v(" "),s("ul",[s("li",[s("p",[t._v("golang代码的性能监控使用pprof包来做。pprof有两个包：")]),t._v(" "),s("ul",[s("li",[s("code",[t._v("runtime/pprof")]),t._v("pprof的具体实现，所有类型的代码都可以使用。如果不是Web应用程序，建议使用该包。")]),t._v(" "),s("li",[s("code",[t._v("net/http/pprof")]),t._v("对"),s("code",[t._v("runtime/pprof")]),t._v("包进行简单封装，并在http端口上暴露出来。适合Web应用程序使用。")])])]),t._v(" "),s("li",[s("p",[t._v("pprof开启后，每隔一段时间（10ms）就会收集下当前的堆栈信息，获取各个函数占用的CPU以及内存资源；最后通过对这些采样数据进行分析，形成一个性能分析报告。")]),t._v(" "),s("blockquote",[s("p",[t._v("注意，我们只应该在性能测试的时候才在代码中引入pprof")])])])]),t._v(" "),s("h2",{attrs:{id:"pprof-监控内容"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#pprof-监控内容"}},[t._v("#")]),t._v(" pprof 监控内容")]),t._v(" "),s("table",[s("thead",[s("tr",[s("th",{staticStyle:{"text-align":"left"}},[t._v("类型")]),t._v(" "),s("th",{staticStyle:{"text-align":"left"}},[t._v("描述")]),t._v(" "),s("th",{staticStyle:{"text-align":"left"}},[t._v("备注")])])]),t._v(" "),s("tbody",[s("tr",[s("td",{staticStyle:{"text-align":"left"}},[s("strong",[t._v("allocs")])]),t._v(" "),s("td",{staticStyle:{"text-align":"left"}},[t._v("内存分配情况的采样信息")]),t._v(" "),s("td",{staticStyle:{"text-align":"left"}},[t._v("可以用浏览器打开，但可读性不高")])]),t._v(" "),s("tr",[s("td",{staticStyle:{"text-align":"left"}},[s("strong",[t._v("blocks")])]),t._v(" "),s("td",{staticStyle:{"text-align":"left"}},[t._v("阻塞操作情况的采样信息")]),t._v(" "),s("td",{staticStyle:{"text-align":"left"}},[t._v("可以用浏览器打开，但可读性不高")])]),t._v(" "),s("tr",[s("td",{staticStyle:{"text-align":"left"}},[t._v("cmdline")]),t._v(" "),s("td",{staticStyle:{"text-align":"left"}},[t._v("显示程序启动命令及参数")]),t._v(" "),s("td",{staticStyle:{"text-align":"left"}},[t._v("可以用浏览器打开，但可读性不高")])]),t._v(" "),s("tr",[s("td",{staticStyle:{"text-align":"left"}},[s("strong",[t._v("goroutine")])]),t._v(" "),s("td",{staticStyle:{"text-align":"left"}},[t._v("当前所有协程的堆栈信息")]),t._v(" "),s("td",{staticStyle:{"text-align":"left"}},[t._v("可以用浏览器打开，但可读性不高")])]),t._v(" "),s("tr",[s("td",{staticStyle:{"text-align":"left"}},[s("strong",[t._v("heap")])]),t._v(" "),s("td",{staticStyle:{"text-align":"left"}},[t._v("堆上内存使用情况的采样信息")]),t._v(" "),s("td",{staticStyle:{"text-align":"left"}},[t._v("可以用浏览器打开，但可读性不高")])]),t._v(" "),s("tr",[s("td",{staticStyle:{"text-align":"left"}},[s("strong",[t._v("mutex")])]),t._v(" "),s("td",{staticStyle:{"text-align":"left"}},[t._v("锁争用情况的采样信息")]),t._v(" "),s("td",{staticStyle:{"text-align":"left"}},[t._v("可以用浏览器打开，但可读性不高")])]),t._v(" "),s("tr",[s("td",{staticStyle:{"text-align":"left"}},[s("strong",[t._v("profile")])]),t._v(" "),s("td",{staticStyle:{"text-align":"left"}},[t._v("CPU 占用情况的采样信息")]),t._v(" "),s("td",{staticStyle:{"text-align":"left"}},[t._v("浏览器打开会下载文件")])]),t._v(" "),s("tr",[s("td",{staticStyle:{"text-align":"left"}},[s("strong",[t._v("threadcreate")])]),t._v(" "),s("td",{staticStyle:{"text-align":"left"}},[t._v("系统线程创建情况的采样信息")]),t._v(" "),s("td",{staticStyle:{"text-align":"left"}},[t._v("可以用浏览器打开，但可读性不高")])]),t._v(" "),s("tr",[s("td",{staticStyle:{"text-align":"left"}},[s("strong",[t._v("trace")])]),t._v(" "),s("td",{staticStyle:{"text-align":"left"}},[t._v("程序运行跟踪信息")]),t._v(" "),s("td",{staticStyle:{"text-align":"left"}},[t._v("浏览器打开会下载文件")])])])]),t._v(" "),s("h2",{attrs:{id:"pprof-使用方法"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#pprof-使用方法"}},[t._v("#")]),t._v(" pprof 使用方法")]),t._v(" "),s("h3",{attrs:{id:"_1-非web应用程序"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_1-非web应用程序"}},[t._v("#")]),t._v(" 1. 非Web应用程序")]),t._v(" "),s("ul",[s("li",[s("p",[t._v("如果你的应用程序是运行一段时间就结束退出类型。那么最好的办法是在应用退出的时候把 profiling 的报告保存到文件中，进行分析。对于这种情况，可以使用"),s("code",[t._v("runtime/pprof")]),t._v("库。 首先在代码中导入"),s("code",[t._v("runtime/pprof")]),t._v("工具：")]),t._v(" "),s("div",{staticClass:"language-go line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-go"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"runtime/pprof"')]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br")])])])]),t._v(" "),s("h4",{attrs:{id:"_1-1-cpu性能分析"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_1-1-cpu性能分析"}},[t._v("#")]),t._v(" 1.1 CPU性能分析")]),t._v(" "),s("ul",[s("li",[s("p",[t._v("开启CPU性能分析：")]),t._v(" "),s("div",{staticClass:"language-go line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-go"}},[s("code",[t._v("pprof"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("StartCPUProfile")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("w io"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Writer"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br")])])]),t._v(" "),s("li",[s("p",[t._v("停止CPU性能分析：")]),t._v(" "),s("div",{staticClass:"language-go line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-go"}},[s("code",[t._v("pprof"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("StopCPUProfile")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\t\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br")])])]),t._v(" "),s("li",[s("p",[t._v("应用执行结束后，就会生成一个文件，保存了我们的 CPU profiling 数据。得到采样数据之后，使用"),s("code",[t._v("go tool pprof")]),t._v("工具进行CPU性能分析。")])])]),t._v(" "),s("h4",{attrs:{id:"_1-2-内存性能优化"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_1-2-内存性能优化"}},[t._v("#")]),t._v(" 1.2 内存性能优化")]),t._v(" "),s("ul",[s("li",[s("p",[t._v("记录程序的堆栈信息")]),t._v(" "),s("div",{staticClass:"language-go line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-go"}},[s("code",[t._v("pprof"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("WriteHeapProfile")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("w io"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Writer"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br")])])]),t._v(" "),s("li",[s("p",[t._v("得到采样数据之后，使用"),s("code",[t._v("go tool pprof")]),t._v("工具进行内存性能分析。")])]),t._v(" "),s("li",[s("p",[s("code",[t._v("go tool pprof")]),t._v("默认是使用"),s("code",[t._v("-inuse_space")]),t._v("进行统计，还可以使用"),s("code",[t._v("-inuse-objects")]),t._v("查看分配对象的数量。")])])]),t._v(" "),s("h3",{attrs:{id:"_2-web应用程序"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-web应用程序"}},[t._v("#")]),t._v(" 2. Web应用程序")]),t._v(" "),s("ul",[s("li",[s("p",[t._v("如果使用了默认的"),s("code",[t._v("http.DefaultServeMux")]),t._v("（通常是代码直接使用 http.ListenAndServe(“0.0.0.0:8000”, nil)），只需要在你的web server端代码中按如下方式导入"),s("code",[t._v("net/http/pprof")])]),t._v(" "),s("div",{staticClass:"language-go line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-go"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("_")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"net/http/pprof"')]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br")])])]),t._v(" "),s("li",[s("p",[t._v("如果你使用自定义的 Mux，则需要手动注册一些路由规则：")]),t._v(" "),s("div",{staticClass:"language-go line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-go"}},[s("code",[t._v("r"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("HandleFunc")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"/debug/pprof/"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" pprof"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Index"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\nr"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("HandleFunc")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"/debug/pprof/cmdline"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" pprof"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Cmdline"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\nr"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("HandleFunc")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"/debug/pprof/profile"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" pprof"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Profile"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\nr"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("HandleFunc")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"/debug/pprof/symbol"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" pprof"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Symbol"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\nr"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("HandleFunc")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"/debug/pprof/trace"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" pprof"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Trace"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br")])])]),t._v(" "),s("li",[s("p",[t._v("如果你使用的是gin框架，那么推荐使用"),s("a",{attrs:{href:"https://github.com/gin-contrib/pprof",target:"_blank",rel:"noopener noreferrer"}},[t._v("github.com/gin-contrib/pprof"),s("OutboundLink")],1),t._v("，在代码中通过以下命令注册pprof相关路由。")]),t._v(" "),s("div",{staticClass:"language-go line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-go"}},[s("code",[t._v("pprof"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("Register")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("router"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br")])])]),t._v(" "),s("li",[s("p",[t._v("不管哪种方式，你的 HTTP 服务都会多出"),s("code",[t._v("/debug/pprof")]),t._v(" endpoint，访问它会得到类似下面的内容：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://raw.githubusercontent.com/hellolib/pictures/main/Typora/pic-00-gitee/20220628172807.png",alt:"debug/pprof"}})])]),t._v(" "),s("li",[s("p",[t._v("这个路径下还有几个子页面：")]),t._v(" "),s("ul",[s("li",[s("p",[s("code",[t._v("/debug/pprof/profile")]),t._v("：访问这个链接会自动进行 CPU profiling，持续 30s，并生成一个文件供下载")])]),t._v(" "),s("li",[s("p",[s("code",[t._v("/debug/pprof/heap")]),t._v("： Memory Profiling 的路径，访问这个链接会得到一个内存 Profiling 结果的文件")])]),t._v(" "),s("li",[s("p",[s("code",[t._v("/debug/pprof/block")]),t._v("：block Profiling 的路径")])]),t._v(" "),s("li",[s("p",[s("code",[t._v("/debug/pprof/goroutines")]),t._v("：运行的 goroutines 列表，以及调用关系")])])])])]),t._v(" "),s("h2",{attrs:{id:"go-tool-pprof命令"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#go-tool-pprof命令"}},[t._v("#")]),t._v(" go tool pprof命令")]),t._v(" "),s("ul",[s("li",[s("p",[t._v("不管是工具型应用还是服务型应用，我们使用相应的pprof库获取数据之后，下一步的都要对这些数据进行分析，我们可以使用"),s("code",[t._v("go tool pprof")]),t._v("命令行工具。")])]),t._v(" "),s("li",[s("p",[s("code",[t._v("go tool pprof")]),t._v("最简单的使用方式为:")]),t._v(" "),s("div",{staticClass:"language-bash line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[t._v("go tool pprof "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("binary"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("source"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br")])]),s("ul",[s("li",[s("p",[t._v("其中：")]),t._v(" "),s("ul",[s("li",[s("p",[t._v("binary 是应用的二进制文件，用来解析各种符号；")])]),t._v(" "),s("li",[s("p",[t._v("source 表示 profile 数据的来源，可以是本地的文件，也可以是 http 地址。")])])])])]),t._v(" "),s("blockquote",[s("p",[s("strong",[t._v("注意事项：")]),t._v(" 获取的 Profiling 数据是动态的，要想获得有效的数据，请保证应用处于较大的负载（比如正在生成中运行的服务，或者通过其他工具模拟访问压力）。否则如果应用处于空闲状态，得到的结果可能没有任何意义。")])])])]),t._v(" "),s("h2",{attrs:{id:"demo"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#demo"}},[t._v("#")]),t._v(" Demo")]),t._v(" "),s("ul",[s("li",[s("p",[t._v("示例一段有问题的代码")]),t._v(" "),s("div",{staticClass:"language-go line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-go"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// pprof/main.go")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("package")]),t._v(" main\n\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n\t"),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"flag"')]),t._v("\n\t"),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"fmt"')]),t._v("\n\t"),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"os"')]),t._v("\n\t"),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"runtime/pprof"')]),t._v("\n\t"),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"time"')]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 一段有问题的代码")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("func")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("logicCode")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("var")]),t._v(" c "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("chan")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("int")]),t._v("\n\t"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\t"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("select")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\t"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("case")]),t._v(" v "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<-")]),t._v("c"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n\t\t\tfmt"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("Printf")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"recv from chan, value:%v\\n"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" v"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t\t"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("default")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n\n\t\t"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\t"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("func")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("main")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("var")]),t._v(" isCPUPprof "),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("bool")]),t._v("\n\t"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("var")]),t._v(" isMemPprof "),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("bool")]),t._v("\n\n\tflag"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("BoolVar")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),t._v("isCPUPprof"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"cpu"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("false")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"turn cpu pprof on"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\tflag"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("BoolVar")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),t._v("isMemPprof"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"mem"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("false")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"turn mem pprof on"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\tflag"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("Parse")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n\t"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" isCPUPprof "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\tfile"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" err "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" os"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("Create")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"./cpu.pprof"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t\t"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" err "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("nil")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\t\tfmt"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("Printf")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"create cpu pprof failed, err:%v\\n"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" err"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t\t\t"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v("\n\t\t"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\t\tpprof"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("StartCPUProfile")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("file"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t\t"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("defer")]),t._v(" pprof"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("StopCPUProfile")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\t"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" i "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" i "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("8")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" i"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("++")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\t"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("go")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("logicCode")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\ttime"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("Sleep")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("20")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" time"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Second"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" isMemPprof "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\tfile"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" err "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" os"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("Create")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"./mem.pprof"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t\t"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" err "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("nil")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\t\tfmt"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("Printf")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"create mem pprof failed, err:%v\\n"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" err"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t\t\t"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v("\n\t\t"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\t\tpprof"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("WriteHeapProfile")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("file"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t\tfile"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("Close")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br"),s("span",{staticClass:"line-number"},[t._v("7")]),s("br"),s("span",{staticClass:"line-number"},[t._v("8")]),s("br"),s("span",{staticClass:"line-number"},[t._v("9")]),s("br"),s("span",{staticClass:"line-number"},[t._v("10")]),s("br"),s("span",{staticClass:"line-number"},[t._v("11")]),s("br"),s("span",{staticClass:"line-number"},[t._v("12")]),s("br"),s("span",{staticClass:"line-number"},[t._v("13")]),s("br"),s("span",{staticClass:"line-number"},[t._v("14")]),s("br"),s("span",{staticClass:"line-number"},[t._v("15")]),s("br"),s("span",{staticClass:"line-number"},[t._v("16")]),s("br"),s("span",{staticClass:"line-number"},[t._v("17")]),s("br"),s("span",{staticClass:"line-number"},[t._v("18")]),s("br"),s("span",{staticClass:"line-number"},[t._v("19")]),s("br"),s("span",{staticClass:"line-number"},[t._v("20")]),s("br"),s("span",{staticClass:"line-number"},[t._v("21")]),s("br"),s("span",{staticClass:"line-number"},[t._v("22")]),s("br"),s("span",{staticClass:"line-number"},[t._v("23")]),s("br"),s("span",{staticClass:"line-number"},[t._v("24")]),s("br"),s("span",{staticClass:"line-number"},[t._v("25")]),s("br"),s("span",{staticClass:"line-number"},[t._v("26")]),s("br"),s("span",{staticClass:"line-number"},[t._v("27")]),s("br"),s("span",{staticClass:"line-number"},[t._v("28")]),s("br"),s("span",{staticClass:"line-number"},[t._v("29")]),s("br"),s("span",{staticClass:"line-number"},[t._v("30")]),s("br"),s("span",{staticClass:"line-number"},[t._v("31")]),s("br"),s("span",{staticClass:"line-number"},[t._v("32")]),s("br"),s("span",{staticClass:"line-number"},[t._v("33")]),s("br"),s("span",{staticClass:"line-number"},[t._v("34")]),s("br"),s("span",{staticClass:"line-number"},[t._v("35")]),s("br"),s("span",{staticClass:"line-number"},[t._v("36")]),s("br"),s("span",{staticClass:"line-number"},[t._v("37")]),s("br"),s("span",{staticClass:"line-number"},[t._v("38")]),s("br"),s("span",{staticClass:"line-number"},[t._v("39")]),s("br"),s("span",{staticClass:"line-number"},[t._v("40")]),s("br"),s("span",{staticClass:"line-number"},[t._v("41")]),s("br"),s("span",{staticClass:"line-number"},[t._v("42")]),s("br"),s("span",{staticClass:"line-number"},[t._v("43")]),s("br"),s("span",{staticClass:"line-number"},[t._v("44")]),s("br"),s("span",{staticClass:"line-number"},[t._v("45")]),s("br"),s("span",{staticClass:"line-number"},[t._v("46")]),s("br"),s("span",{staticClass:"line-number"},[t._v("47")]),s("br"),s("span",{staticClass:"line-number"},[t._v("48")]),s("br"),s("span",{staticClass:"line-number"},[t._v("49")]),s("br"),s("span",{staticClass:"line-number"},[t._v("50")]),s("br"),s("span",{staticClass:"line-number"},[t._v("51")]),s("br"),s("span",{staticClass:"line-number"},[t._v("52")]),s("br"),s("span",{staticClass:"line-number"},[t._v("53")]),s("br"),s("span",{staticClass:"line-number"},[t._v("54")]),s("br"),s("span",{staticClass:"line-number"},[t._v("55")]),s("br"),s("span",{staticClass:"line-number"},[t._v("56")]),s("br")])]),s("ul",[s("li",[t._v("打包运行\n"),s("ul",[s("li",[t._v("go build main.go")]),t._v(" "),s("li",[t._v("./main -cpu")])])])])]),t._v(" "),s("li",[s("p",[t._v("等待30秒后会在当前目录下生成一个"),s("code",[t._v("cpu.pprof")]),t._v("文件。")])])]),t._v(" "),s("h3",{attrs:{id:"_1-命令行交互界面"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_1-命令行交互界面"}},[t._v("#")]),t._v(" 1. 命令行交互界面")]),t._v(" "),s("ul",[s("li",[s("p",[t._v("使用go工具链里的"),s("code",[t._v("pprof")]),t._v("来分析一下。")]),t._v(" "),s("div",{staticClass:"language-bash line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[t._v("go tool pprof cpu.pprof\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br")])])]),t._v(" "),s("li",[s("p",[t._v("执行上面的代码会进入交互界面如下：")]),t._v(" "),s("div",{staticClass:"language-bash line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[t._v("runtime_pprof $ go tool pprof cpu.pprof\nType: cpu\nTime: Jun "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("28")]),t._v(", "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("2019")]),t._v(" at "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("11")]),t._v(":28am "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("CST"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\nDuration: "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("20")]),t._v(".13s, Total samples "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v(".91mins "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("568.60")]),t._v("%"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\nEntering interactive mode "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("type "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"help"')]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" commands, "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"o"')]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" options"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("pprof"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("  \n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br")])])]),t._v(" "),s("li",[s("p",[t._v("我们可以在交互界面输入"),s("code",[t._v("top3")]),t._v("来查看程序中占用CPU前3位的函数：")]),t._v(" "),s("div",{staticClass:"language-bash line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("pprof"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" top3\nShowing nodes accounting "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("100")]),t._v(".37s, "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("87.68")]),t._v("% of "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("114")]),t._v(".47s total\nDropped "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("17")]),t._v(" nodes "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("cum "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v(".57s"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\nShowing "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("top")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("3")]),t._v(" nodes out of "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("4")]),t._v("\n      flat  flat%   sum%        cum   cum%\n    "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("42")]),t._v(".52s "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("37.15")]),t._v("% "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("37.15")]),t._v("%     "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("91")]),t._v(".73s "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("80.13")]),t._v("%  runtime.selectnbrecv\n    "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("35")]),t._v(".21s "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("30.76")]),t._v("% "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("67.90")]),t._v("%     "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("39")]),t._v(".49s "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("34.50")]),t._v("%  runtime.chanrecv\n    "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("22")]),t._v(".64s "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("19.78")]),t._v("% "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("87.68")]),t._v("%    "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("114")]),t._v(".37s "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("99.91")]),t._v("%  main.logicCode\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br"),s("span",{staticClass:"line-number"},[t._v("7")]),s("br"),s("span",{staticClass:"line-number"},[t._v("8")]),s("br")])]),s("ul",[s("li",[s("p",[t._v("flat：当前函数占用CPU的耗时")])]),t._v(" "),s("li",[s("p",[t._v("flat%：:当前函数占用CPU的耗时百分比")])]),t._v(" "),s("li",[s("p",[t._v("sun%：函数占用CPU的耗时累计百分比")])]),t._v(" "),s("li",[s("p",[t._v("cum：当前函数加上调用当前函数的函数占用CPU的总耗时")])]),t._v(" "),s("li",[s("p",[t._v("cum%：当前函数加上调用当前函数的函数占用CPU的总耗时百分比")])]),t._v(" "),s("li",[s("p",[t._v("最后一列：函数名称")])])])]),t._v(" "),s("li",[s("p",[t._v("在大多数的情况下，我们可以通过分析这五列得出一个应用程序的运行情况，并对程序进行优化。")])]),t._v(" "),s("li",[s("p",[t._v("我们还可以使用"),s("code",[t._v("list 函数名")]),t._v("命令查看具体的函数分析，例如执行"),s("code",[t._v("list logicCode")]),t._v("查看我们编写的函数的详细分析。")]),t._v(" "),s("div",{staticClass:"language-bash line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("pprof"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" list logicCode\nTotal: "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v(".91mins\nROUTINE "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),t._v(" main.logicCode "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("in")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),t._v("./runtime_pprof/main.go\n    "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("22")]),t._v(".64s   "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v(".91mins "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("flat, cum"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("99.91")]),t._v("% of Total\n         "),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(".")]),t._v("          "),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(".")]),t._v("     "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("12")]),t._v(":func "),s("span",{pre:!0,attrs:{class:"token function-name function"}},[t._v("logicCode")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n         "),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(".")]),t._v("          "),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(".")]),t._v("     "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("13")]),t._v(":   var c chan int\n         "),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(".")]),t._v("          "),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(".")]),t._v("     "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("14")]),t._v(":   "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n         "),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(".")]),t._v("          "),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(".")]),t._v("     "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("15")]),t._v(":           "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("select")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n         "),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(".")]),t._v("          "),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(".")]),t._v("     "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("16")]),t._v(":           "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("case")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("v")]),t._v(" :"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("-c:\n    "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("22")]),t._v(".64s   "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v(".91mins     "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("17")]),t._v(":                   fmt.Printf"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"recv from chan, value:%v'),s("span",{pre:!0,attrs:{class:"token entity",title:"\\n"}},[t._v("\\n")]),t._v('"')]),t._v(", "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("v")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n         "),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(".")]),t._v("          "),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(".")]),t._v("     "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("18")]),t._v(":           default:\n         "),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(".")]),t._v("          "),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(".")]),t._v("     "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("19")]),t._v(":\n         "),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(".")]),t._v("          "),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(".")]),t._v("     "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("20")]),t._v(":           "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n         "),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(".")]),t._v("          "),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(".")]),t._v("     "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("21")]),t._v(":   "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n         "),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(".")]),t._v("          "),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(".")]),t._v("     "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("22")]),t._v(":"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br"),s("span",{staticClass:"line-number"},[t._v("7")]),s("br"),s("span",{staticClass:"line-number"},[t._v("8")]),s("br"),s("span",{staticClass:"line-number"},[t._v("9")]),s("br"),s("span",{staticClass:"line-number"},[t._v("10")]),s("br"),s("span",{staticClass:"line-number"},[t._v("11")]),s("br"),s("span",{staticClass:"line-number"},[t._v("12")]),s("br"),s("span",{staticClass:"line-number"},[t._v("13")]),s("br"),s("span",{staticClass:"line-number"},[t._v("14")]),s("br"),s("span",{staticClass:"line-number"},[t._v("15")]),s("br")])])]),t._v(" "),s("li",[s("p",[t._v("通过分析发现大部分CPU资源被17行占用，我们分析出select语句中的default没有内容会导致上面的"),s("code",[t._v("case v:=<-c:")]),t._v("一直执行。我们在default分支添加一行"),s("code",[t._v("time.Sleep(time.Second)")]),t._v("即可。")])])]),t._v(" "),s("h3",{attrs:{id:"_2-图形化"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-图形化"}},[t._v("#")]),t._v(" 2. 图形化")]),t._v(" "),s("ul",[s("li",[t._v("或者可以直接输入web，通过svg图的方式查看程序中详细的CPU占用情况。 想要查看图形化的界面首先需要安装"),s("a",{attrs:{href:"https://graphviz.gitlab.io/",target:"_blank",rel:"noopener noreferrer"}},[t._v("graphviz"),s("OutboundLink")],1),t._v("图形化工具。\n"),s("ul",[s("li",[s("p",[t._v("Mac：")]),t._v(" "),s("div",{staticClass:"language-bash line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[t._v("brew "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("install")]),t._v(" graphviz\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br")])])]),t._v(" "),s("li",[s("p",[t._v("Windows: 下载"),s("a",{attrs:{href:"https://graphviz.gitlab.io/_pages/Download/Download_windows.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("graphviz"),s("OutboundLink")],1),t._v(" 将"),s("code",[t._v("graphviz")]),t._v("安装目录下的bin文件夹添加到Path环境变量中。 在终端输入"),s("code",[t._v("dot -version")]),t._v("查看是否安装成功。")])])])])]),t._v(" "),s("p",[s("img",{attrs:{src:"https://raw.githubusercontent.com/hellolib/pictures/main/Typora/pic-00-gitee/20220628173750.png",alt:"image-20220628173750115"}})]),t._v(" "),s("ul",[s("li",[s("p",[t._v("关于图形的说明： 每个框代表一个函数，理论上框的越大表示占用的CPU资源越多。 方框之间的线条代表函数之间的调用关系。 线条上的数字表示函数调用的次数。 方框中的第一行数字表示当前函数占用CPU的百分比，第二行数字表示当前函数累计占用CPU的百分比。")])]),t._v(" "),s("li",[s("p",[t._v("除了分析CPU性能数据，pprof也支持分析内存性能数据。比如，使用下面的命令分析http服务的heap性能数据，查看当前程序的内存占用以及热点内存对象使用的情况。")]),t._v(" "),s("div",{staticClass:"language-bash line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 查看内存占用数据")]),t._v("\ngo tool pprof -inuse_space http://127.0.0.1:8080/debug/pprof/heap\ngo tool pprof -inuse_objects http://127.0.0.1:8080/debug/pprof/heap\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 查看临时内存分配数据")]),t._v("\ngo tool pprof -alloc_space http://127.0.0.1:8080/debug/pprof/heap\ngo tool pprof -alloc_objects http://127.0.0.1:8080/debug/pprof/heap\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br")])])])]),t._v(" "),s("h2",{attrs:{id:"火焰图"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#火焰图"}},[t._v("#")]),t._v(" 火焰图")]),t._v(" "),s("ul",[s("li",[s("p",[t._v("火焰图（Flame Graph）是 Bredan Gregg 创建的一种性能分析图表，因为它的样子近似火焰而得名。golang性能监控结果可以转换成火焰图来进行直观展示。火焰图 svg 文件可以通过浏览器打开，它展示调用图的最大优点是火焰图动态的——可以通过点击每个方块来分析它上层概况/下层详细的内容。")])]),t._v(" "),s("li",[s("p",[t._v("火焰图的调用顺序从下到上，每个方块代表一个函数，它上面一层表示这个函数会调用哪些函数，方块的大小代表了占用资源值的多少（例如，CPU使用时间的长短，内存使用的大小等）。火焰图的配色并没有特殊的意义，默认的红、黄配色是为了更像火焰而已。\n生成火焰图，有两种方式："),s("strong",[t._v("go-torch")]),t._v("（golang version < 1.10）和golang原生的"),s("strong",[t._v("pprof")]),t._v("（golang version < 1.10+的pprof集成了火焰图功能）")])]),t._v(" "),s("li",[s("p",[t._v("用go tool pprof可以在Web界面上查看所有类型的资源监控图。")]),t._v(" "),s("ul",[s("li",[s("p",[t._v("例如，使用pprof查看Web服务器的阻塞监控数据，并将结果展示在6061端口。通过**"),s("a",{attrs:{href:"https://links.jianshu.com/go?to=http%3A%2F%2Flocalhost%3A6062%2Fui%2Fflamegraph",target:"_blank",rel:"noopener noreferrer"}},[t._v("http://localhost:6062/ui/flamegraph"),s("OutboundLink")],1),t._v("**即可查看生成的火焰图。")]),t._v(" "),s("div",{staticClass:"language-shell line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[t._v("$ go tool pprof -http"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(":6061 http://localhost:6060/debug/pprof/block\n\nFetching profile over HTTP from http://localhost:6060/debug/pprof/block\nSaved profile "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("in")]),t._v(" /home/jerry/pprof/pprof.___go_build_main_go.contentions.delay.005.pb.gz\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br")])])])])]),t._v(" "),s("li",[s("p",[t._v("从执行命令的过程，可以看到pprof工具从"),s("a",{attrs:{href:"https://links.jianshu.com/go?to=http%3A%2F%2Flocalhost%3A6060%2Fdebug%2Fpprof%2Fblock",target:"_blank",rel:"noopener noreferrer"}},[t._v("http://localhost:6060/debug/pprof/block"),s("OutboundLink")],1),t._v("获取监控数据，并保存到本地：/home/jerry/pprof/pprof.___go_build_main_go.contentions.delay.005.pb.gz。然后对该文件进行分析，并启动一个Web服务器："),s("a",{attrs:{href:"https://links.jianshu.com/go?to=http%3A%2F%2Flocalhost%3A6061",target:"_blank",rel:"noopener noreferrer"}},[t._v("http://localhost:6061"),s("OutboundLink")],1),t._v("。一般会自动弹出一个浏览器并显示结果——默认显示的是graph。但是可以从第一行的菜单中切换View，选择"),s("code",[t._v("Flame Graph")]),t._v("即可显示火焰图。")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://raw.githubusercontent.com/hellolib/pictures/main/Typora/pic-00-gitee/20220628192032.png",alt:"image-20220628192032008"}})])])]),t._v(" "),s("h2",{attrs:{id:"pprof与性能测试结合"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#pprof与性能测试结合"}},[t._v("#")]),t._v(" pprof与性能测试结合")]),t._v(" "),s("ul",[s("li",[s("p",[s("code",[t._v("go test")]),t._v("命令有两个参数和 pprof 相关，它们分别指定生成的 CPU 和 Memory profiling 保存的文件：")]),t._v(" "),s("ul",[s("li",[s("p",[s("code",[t._v("-cpuprofile")]),t._v("：cpu profiling 数据要保存的文件地址")])]),t._v(" "),s("li",[s("p",[s("code",[t._v("-memprofile")]),t._v("：memory profiling 数据要报文的文件地址")])])])]),t._v(" "),s("li",[s("p",[t._v("我们还可以选择将pprof与性能测试相结合，比如：")]),t._v(" "),s("ul",[s("li",[s("p",[t._v("下面执行测试的同时，也会执行 CPU profiling，并把结果保存在 cpu.prof 文件中：")]),t._v(" "),s("div",{staticClass:"language-bash line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[t._v("go "),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("test")]),t._v(" -bench "),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(".")]),t._v(" -cpuprofile"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("cpu.prof\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br")])]),s("ul",[s("li",[t._v("比如下面执行测试的同时，也会执行 Mem profiling，并把结果保存在 cpu.prof 文件中：")])]),t._v(" "),s("div",{staticClass:"language-bash line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[t._v("go "),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("test")]),t._v(" -bench "),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(".")]),t._v(" -memprofile"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("./mem.prof\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br")])])])])]),t._v(" "),s("li",[s("p",[t._v("需要注意的是，Profiling 一般和性能测试一起使用，这个原因在前文也提到过，只有应用在负载高的情况下 Profiling 才有意义。")])])])])}),[],!1,null,null,null);s.default=e.exports}}]);