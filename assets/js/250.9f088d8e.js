(window.webpackJsonp=window.webpackJsonp||[]).push([[250],{569:function(s,t,a){"use strict";a.r(t);var e=a(3),n=Object(e.a)({},(function(){var s=this,t=s._self._c;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("h2",{attrs:{id:"需求背景"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#需求背景"}},[s._v("#")]),s._v(" 需求背景")]),s._v(" "),t("h3",{attrs:{id:"_1-背景"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-背景"}},[s._v("#")]),s._v(" 1. 背景")]),s._v(" "),t("ul",[t("li",[t("p",[s._v("go项目部署时只需要提供build出来的二进制包")])]),s._v(" "),t("li",[t("p",[s._v("go 项目build出来的二进制包对于不同架构的机器和系统并不兼容")])])]),s._v(" "),t("h3",{attrs:{id:"_2-需求"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-需求"}},[s._v("#")]),s._v(" 2. 需求")]),s._v(" "),t("ul",[t("li",[s._v("docker 构建的镜像要尽可能的小")]),s._v(" "),t("li",[s._v("构建出镜像与线上环境环境完美兼容")])]),s._v(" "),t("h3",{attrs:{id:"_3-方案"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-方案"}},[s._v("#")]),s._v(" 3. 方案")]),s._v(" "),t("ol",[t("li",[s._v("将可执行文件放入最小镜像alpine中 ✅")]),s._v(" "),t("li",[s._v("例如用window开发, 线上环境为centos7X86环境, 我们就可以在window中安装centos7x86虚拟环境, 上传代码到虚拟机,构建完镜像上传生产环境. 可行不? 可行! 麻烦不?是真麻烦! 多出了一个操作步骤,而且通用镜像编译后的文件在 alpine 镜像中不一定能执行。❎")]),s._v(" "),t("li",[s._v("多阶段构建 ,简单好用✅")])]),s._v(" "),t("h2",{attrs:{id:"多阶段构建"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#多阶段构建"}},[s._v("#")]),s._v(" 多阶段构建")]),s._v(" "),t("ul",[t("li",[t("strong",[s._v("Docker 17.05")]),s._v("版本以后，官方提供了一个新的特性："),t("code",[s._v("Multi-stage builds")]),s._v("（多阶段构建）。")]),s._v(" "),t("li",[s._v("多阶段构建，就是可以在一个 "),t("code",[s._v("Dockerfile")]),s._v(" 中使用多个 FROM 语句。每个 FROM 指令都可以使用不同的基础镜像，并表示开始一个新的构建阶段。你\\可以很方便的将一个阶段的文件复制到另外一个阶段，在最终的镜像中保留下你\\需要的内容即可。")])]),s._v(" "),t("h3",{attrs:{id:"_1-demo"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-demo"}},[s._v("#")]),s._v(" 1. demo")]),s._v(" "),t("ul",[t("li",[t("p",[s._v("代码示例")]),s._v(" "),t("div",{staticClass:"language-dockerfile line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-dockerfile"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 一阶段 (模拟生产环境构建项目代码)")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("FROM")]),s._v(" golang:1.7.3 "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("as")]),s._v(" builder")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("WORKDIR")]),s._v(" /go/src/github.com/alexellis/href-counter/")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("RUN")]),s._v(" go get -d -v golang.org/x/net/html  ")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("COPY")]),s._v(" app.go .")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("RUN")]),s._v(" CGO_ENABLED=0 GOOS=linux go build -a -installsuffix cgo -o app .")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 二阶段 (构键最终镜像)")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("FROM")]),s._v(" alpine:latest  ")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("RUN")]),s._v(" apk --no-cache add ca-certificates")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("WORKDIR")]),s._v(" /root/")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("COPY")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token options"}},[t("span",{pre:!0,attrs:{class:"token property"}},[s._v("--from")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("builder")])]),s._v(" /go/src/github.com/alexellis/href-counter/app .")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("CMD")]),s._v(" ["),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"./app"')]),s._v("] ")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br")])]),t("p",[t("code",[s._v("docker build -t app:latest .")])])])]),s._v(" "),t("h3",{attrs:{id:"_2-停在特定的构建阶段"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-停在特定的构建阶段"}},[s._v("#")]),s._v(" 2. 停在特定的构建阶段")]),s._v(" "),t("ul",[t("li",[t("p",[s._v("构建镜像时，不一定需要构建整个Dockerfile每个阶段。可以指定目标构建阶段。以下命令假定您使用的是以前的Dockerfile，但在名为builder的阶段停止")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" build --target builder -t alexellis2/href-counter:latest "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(".")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])])]),s._v(" "),t("li",[t("p",[s._v("使用场景:")]),s._v(" "),t("ul",[t("li",[s._v("调试特定的构建阶段")]),s._v(" "),t("li",[s._v("在debug阶段，启用所有调试或工具，而在production阶段尽量精简")]),s._v(" "),t("li",[s._v("在testing阶段，您的应用程序将填充测试数据，但在production阶段则使用生产数据")])])])]),s._v(" "),t("h3",{attrs:{id:"_3-使用外部镜像作为stage"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-使用外部镜像作为stage"}},[s._v("#")]),s._v(" 3. 使用外部镜像作为stage")]),s._v(" "),t("ul",[t("li",[t("p",[s._v("可以使用COPY –from指令从单独的image中复制，使用本地image名称，本地或Docker注册表中可用的标记或标记ID。")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("COPY --from"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("nginx:latest /etc/nginx/nginx.conf /nginx.conf\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])])])])])}),[],!1,null,null,null);t.default=n.exports}}]);