(window.webpackJsonp=window.webpackJsonp||[]).push([[40],{359:function(s,t,a){"use strict";a.r(t);var n=a(3),e=Object(n.a)({},(function(){var s=this,t=s._self._c;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("h1",{attrs:{id:"一-内存为什么需要管理"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#一-内存为什么需要管理"}},[s._v("#")]),s._v(" 一. 内存为什么需要管理？")]),s._v(" "),t("ul",[t("li",[t("p",[s._v("我们将大部分程序逻辑临时用的数据，全部都存在内存之中，比如，"),t("code",[s._v("变量")]),s._v("、"),t("code",[s._v("全局变量")]),s._v("、"),t("code",[s._v("函数跳转地址")]),s._v("、"),t("code",[s._v("静态库")]),s._v("、"),t("code",[s._v("执行代码")]),s._v("、"),t("code",[s._v("临时开辟的内存结构体(对象)")]),s._v("等。")])]),s._v(" "),t("li",[t("p",[s._v("当我们希望存储的东西越来越多，也就发现物理内存的容量依然是不够用，那么对物理内存的利用率和合理的分配，管理就变得非常的重要。")]),s._v(" "),t("p",[s._v("1、首先操作系统就会对内存进行非常详细的管理，")]),s._v(" "),t("p",[s._v("2、其次基于操作系统的基础上，不同语言的内存管理机制也应允而生，但是有的一些语言并没有提供自动的")]),s._v(" "),t("p",[s._v("内存管理模式，有的语言就已经提供了自身程序的内存管理模式：")]),s._v(" "),t("table",[t("thead",[t("tr",[t("th",{staticStyle:{"text-align":"left"}},[s._v("内存自动管理的语言(部分)")]),s._v(" "),t("th",{staticStyle:{"text-align":"left"}},[s._v("非自动管理的语言(部分)")])])]),s._v(" "),t("tbody",[t("tr",[t("td",{staticStyle:{"text-align":"left"}},[s._v("Golang")]),s._v(" "),t("td",{staticStyle:{"text-align":"left"}},[s._v("C")])]),s._v(" "),t("tr",[t("td",{staticStyle:{"text-align":"left"}},[s._v("Java")]),s._v(" "),t("td",{staticStyle:{"text-align":"left"}},[s._v("C++")])]),s._v(" "),t("tr",[t("td",{staticStyle:{"text-align":"left"}},[s._v("Python")]),s._v(" "),t("td",{staticStyle:{"text-align":"left"}},[s._v("Rust")])])])])])]),s._v(" "),t("h1",{attrs:{id:"二-go内存管理"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#二-go内存管理"}},[s._v("#")]),s._v(" 二. Go内存管理")]),s._v(" "),t("ul",[t("li",[t("p",[s._v("Go语言内置运行时（就是runtime），抛弃了传统的内存分配方式，改为自主管理。这样可以自主地实现更好的内存使用模式，比如内存池、预分配等等。这样，不会每次内存分配都需要进行系统调用。")])]),s._v(" "),t("li",[t("p",[s._v("Golang运行时的内存分配算法主要源自 Google 为 C 语言开发的"),t("code",[s._v("TCMalloc算法")]),s._v("，全称"),t("code",[s._v("Thread-Caching Malloc")]),s._v("。核心思想就是把内存分为多级管理，从而降低锁的粒度。它将可用的堆内存采用二级分配的方式进行管理：每个线程都会自行维护一个独立的内存池，进行内存分配时优先从该内存池中分配，当内存池不足时才会向全局内存池申请，以避免不同线程对全局内存池的频繁竞争。")])])]),s._v(" "),t("h2",{attrs:{id:"_1-基础概念"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-基础概念"}},[s._v("#")]),s._v(" 1. 基础概念")]),s._v(" "),t("ul",[t("li",[t("p",[s._v("Go在程序启动的时候，会先向操作系统申请一块内存（注意这时还只是一段虚拟的地址空间，并不会真正地分配内存），切成小块后自己进行管理。")])]),s._v(" "),t("li",[t("p",[s._v("申请到的内存块被分配了三个区域，在X64上分别是512MB，16GB，512GB大小。\n"),t("img",{attrs:{src:"https://raw.githubusercontent.com/hellolib/pictures/main/Typora/pic-00-gitee/20220617173415.jpg",alt:"img"}})])]),s._v(" "),t("li",[t("p",[t("code",[s._v("arena区域")]),s._v("就是我们所谓的堆区，Go动态分配的内存都是在这个区域，它把内存分割成"),t("code",[s._v("8KB")]),s._v("大小的页，一些页组合起来称为"),t("code",[s._v("mspan")]),s._v("。")])]),s._v(" "),t("li",[t("p",[t("code",[s._v("bitmap区域")]),s._v("标识"),t("code",[s._v("arena")]),s._v("区域哪些地址保存了对象，并且用"),t("code",[s._v("4bit")]),s._v("标志位表示对象是否包含指针、"),t("code",[s._v("GC")]),s._v("标记信息。"),t("code",[s._v("bitmap")]),s._v("中一个"),t("code",[s._v("byte")]),s._v("大小的内存对应"),t("code",[s._v("arena")]),s._v("区域中4个指针大小（指针大小为 8B ）的内存，所以"),t("code",[s._v("bitmap")]),s._v("区域的大小是"),t("code",[s._v("512GB/(4*8B)=16GB")]),s._v("。")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://raw.githubusercontent.com/hellolib/pictures/main/Typora/pic-00-gitee/20220617173523.jpg",alt:"img"}}),s._v(" "),t("img",{attrs:{src:"https://raw.githubusercontent.com/hellolib/pictures/main/Typora/pic-00-gitee/20220617173603.jpg",alt:"img"}})])]),s._v(" "),t("li",[t("p",[s._v("从上图其实还可以看到bitmap的高地址部分指向arena区域的低地址部分，也就是说bitmap的地址是由高地址向低地址增长的。")])]),s._v(" "),t("li",[t("p",[t("code",[s._v("spans区域")]),s._v("存放"),t("code",[s._v("mspan")]),s._v("（也就是一些"),t("code",[s._v("arena")]),s._v("分割的页组合起来的内存管理基本单元，后文会再讲）的指针，每个指针对应一页，所以"),t("code",[s._v("spans")]),s._v("区域的大小就是"),t("code",[s._v("512GB/8KB*8B=512MB")]),s._v("。除以8KB是计算"),t("code",[s._v("arena")]),s._v("区域的页数，而最后乘以8是计算"),t("code",[s._v("spans")]),s._v("区域所有指针的大小。创建"),t("code",[s._v("mspan")]),s._v("的时候，按页填充对应的"),t("code",[s._v("spans")]),s._v("区域，在回收"),t("code",[s._v("object")]),s._v("时，根据地址很容易就能找到它所属的"),t("code",[s._v("mspan")]),s._v("。")])])]),s._v(" "),t("h2",{attrs:{id:"_2-内存管理单元"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-内存管理单元"}},[s._v("#")]),s._v(" 2. 内存管理单元")]),s._v(" "),t("ul",[t("li",[t("p",[t("code",[s._v("mspan")]),s._v("：Go中内存管理的基本单元，是由一片连续的"),t("code",[s._v("8KB")]),s._v("的页组成的大块内存。注意，这里的页和操作系统本身的页并不是一回事，它一般是操作系统页大小的几倍。一句话概括："),t("code",[s._v("mspan")]),s._v("是一个包含起始地址、"),t("code",[s._v("mspan")]),s._v("规格、页的数量等内容的双端链表。")])]),s._v(" "),t("li",[t("p",[s._v("每个"),t("code",[s._v("mspan")]),s._v("按照它自身的属性"),t("code",[s._v("Size Class")]),s._v("的大小分割成若干个"),t("code",[s._v("object")]),s._v("，每个"),t("code",[s._v("object")]),s._v("可存储一个对象。并且会使用一个位图来标记其尚未使用的"),t("code",[s._v("object")]),s._v("。属性"),t("code",[s._v("Size Class")]),s._v("决定"),t("code",[s._v("object")]),s._v("大小，而"),t("code",[s._v("mspan")]),s._v("只会分配给和"),t("code",[s._v("object")]),s._v("尺寸大小接近的对象，当然，对象的大小要小于"),t("code",[s._v("object")]),s._v("大小。还有一个概念："),t("code",[s._v("Span Class")]),s._v("，它和"),t("code",[s._v("Size Class")]),s._v("的含义差不多")]),s._v(" "),t("p",[t("code",[s._v("Size_Class = Span_Class / 2")])])]),s._v(" "),t("li",[t("p",[s._v("这是因为其实每个 "),t("code",[s._v("Size Class")]),s._v("有两个"),t("code",[s._v("mspan")]),s._v("，也就是有两个"),t("code",[s._v("Span Class")]),s._v("。其中一个分配给含有指针的对象，另一个分配给不含有指针的对象。这会给垃圾回收机制带来利好，之后的文章再谈。")])]),s._v(" "),t("li",[t("p",[s._v("如下图，"),t("code",[s._v("mspan")]),s._v("由一组连续的页组成，按照一定大小划分成"),t("code",[s._v("object")]),s._v("。\n"),t("img",{attrs:{src:"https://raw.githubusercontent.com/hellolib/pictures/main/Typora/pic-00-gitee/20220617173921.jpg",alt:"img"}})])]),s._v(" "),t("li",[t("p",[s._v("Go1.9.2里"),t("code",[s._v("mspan")]),s._v("的"),t("code",[s._v("Size Class")]),s._v("共有67种，每种"),t("code",[s._v("mspan")]),s._v("分割的object大小是8*2n的倍数，这个是写死在代码里的：")]),s._v(" "),t("div",{staticClass:"language-go line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-go"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// path: /usr/local/go/src/runtime/sizeclasses.go")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("const")]),s._v(" _NumSizeClasses "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("67")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("var")]),s._v(" class_to_size "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("_NumSizeClasses"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("uint16")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("8")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("16")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("32")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("48")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("64")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("80")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("96")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("112")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("128")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("144")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("160")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("176")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("192")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("208")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("224")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("240")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("256")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("288")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("320")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("352")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("384")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("416")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("448")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("480")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("512")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("576")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("640")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("704")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("768")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("896")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1024")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1152")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1280")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1408")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1536")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1792")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2048")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2304")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2688")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("3072")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("3200")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("3456")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("4096")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("4864")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("5376")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("6144")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("6528")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("6784")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("6912")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("8192")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("9472")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("9728")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("10240")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("10880")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("12288")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("13568")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("14336")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("16384")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("18432")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("19072")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("20480")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("21760")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("24576")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("27264")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("28672")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("32768")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br")])])]),s._v(" "),t("li",[t("p",[s._v("根据"),t("code",[s._v("mspan")]),s._v("的"),t("code",[s._v("Size Class")]),s._v("可以得到它划分的"),t("code",[s._v("object")]),s._v("大小。 比如"),t("code",[s._v("Size Class")]),s._v("等于3，"),t("code",[s._v("object")]),s._v("大小就是32B。 32B大小的object可以存储对象大小范围在17B~32B的对象。而对于微小对象（小于16B），"),t("a",{attrs:{href:"https://www.zhihu.com/search?q=%E5%88%86%E9%85%8D%E5%99%A8&search_source=Entity&hybrid_search_source=Entity&hybrid_search_extra=%7B%22sourceType%22%3A%22article%22%2C%22sourceId%22%3A59125443%7D",target:"_blank",rel:"noopener noreferrer"}},[s._v("分配器"),t("OutboundLink")],1),s._v("会将其进行合并，将几个对象分配到同一个"),t("code",[s._v("object")]),s._v("中。")])]),s._v(" "),t("li",[t("p",[s._v("数组里最大的数是32768，也就是32KB，超过此大小就是大对象了，它会被特别对待，这个稍后会再介绍。顺便提一句，类型"),t("code",[s._v("Size Class")]),s._v("为0表示大对象，它实际上直接由堆内存分配，而小对象都要通过"),t("code",[s._v("mspan")]),s._v("来分配。")])]),s._v(" "),t("li",[t("p",[s._v("对于mspan来说，它的"),t("code",[s._v("Size Class")]),s._v("会决定它所能分到的页数，这也是写死在代码里的：")]),s._v(" "),t("div",{staticClass:"language-go line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-go"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// path: /usr/local/go/src/runtime/sizeclasses.go")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("const")]),s._v(" _NumSizeClasses "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("67")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("var")]),s._v(" class_to_allocnpages "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("_NumSizeClasses"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("uint8")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("6")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("7")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("6")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("7")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("9")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("7")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("8")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("7")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br")])])]),s._v(" "),t("li",[t("p",[s._v("比如当我们要申请一个"),t("code",[s._v("object")]),s._v("大小为"),t("code",[s._v("32B")]),s._v("的"),t("code",[s._v("mspan")]),s._v("的时候，在class_to_size里对应的索引是3，而索引3在"),t("code",[s._v("class_to_allocnpages")]),s._v("数组里对应的页数就是1。")])]),s._v(" "),t("li",[t("p",[t("code",[s._v("mspan")]),s._v("结构体定义：")]),s._v(" "),t("div",{staticClass:"language-go line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-go"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// path: /usr/local/go/src/runtime/mheap.go")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("type")]),s._v(" mspan "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("struct")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//链表前向指针，用于将span链接起来")]),s._v("\n    next "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("mspan \n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//链表前向指针，用于将span链接起来")]),s._v("\n    prev "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("mspan \n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 起始地址，也即所管理页的地址")]),s._v("\n    startAddr "),t("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("uintptr")]),s._v(" \n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 管理的页数")]),s._v("\n    npages "),t("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("uintptr")]),s._v(" \n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 块个数，表示有多少个块可供分配")]),s._v("\n    nelems "),t("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("uintptr")]),s._v(" \n\n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//分配位图，每一位代表一个块是否已分配")]),s._v("\n    allocBits "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("gcBits \n\n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 已分配块的个数")]),s._v("\n    allocCount "),t("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("uint16")]),s._v(" \n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// class表中的class ID，和Size Classs相关")]),s._v("\n    spanclass spanClass  \n\n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// class表中的对象大小，也即块大小")]),s._v("\n    elemsize "),t("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("uintptr")]),s._v(" \n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br"),t("span",{staticClass:"line-number"},[s._v("25")]),t("br")])])]),s._v(" "),t("li",[t("p",[s._v("我们将"),t("code",[s._v("mspan")]),s._v("放到更大的视角来看：")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://raw.githubusercontent.com/hellolib/pictures/main/Typora/pic-00-gitee/20220617174208.jpg",alt:"img"}})])]),s._v(" "),t("li",[t("p",[s._v("上图可以看到有两个"),t("code",[s._v("S")]),s._v("指向了同一个"),t("code",[s._v("mspan")]),s._v("，因为这两个"),t("code",[s._v("S")]),s._v("指向的"),t("code",[s._v("P")]),s._v("是同属一个"),t("code",[s._v("mspan")]),s._v("的。所以，通过"),t("code",[s._v("arena")]),s._v("上的地址可以快速找到指向它的"),t("code",[s._v("S")]),s._v("，通过"),t("code",[s._v("S")]),s._v("就能找到"),t("code",[s._v("mspan")]),s._v("，回忆一下前面我们说的"),t("code",[s._v("mspan")]),s._v("区域的每个指针对应一页。")])]),s._v(" "),t("li",[t("p",[s._v("假设最左边第一个"),t("code",[s._v("mspan")]),s._v("的"),t("code",[s._v("Size Class")]),s._v("等于10，根据前面的"),t("code",[s._v("class_to_size")]),s._v("数组，得出这个"),t("code",[s._v("msapn")]),s._v("分割的"),t("code",[s._v("object")]),s._v("大小是144B，算出可分配的对象个数是"),t("code",[s._v("8KB/144B=56.89")]),s._v("个，取整56个，所以会有一些内存浪费掉了，Go的源码里有所有"),t("code",[s._v("Size Class")]),s._v("的"),t("code",[s._v("mspan")]),s._v("浪费的内存的大小；再根据"),t("code",[s._v("class_to_allocnpages")]),s._v("数组，得到这个"),t("code",[s._v("mspan")]),s._v("只由1个"),t("code",[s._v("page")]),s._v("组成；假设这个"),t("code",[s._v("mspan")]),s._v("是分配给无指针对象的，那么"),t("code",[s._v("spanClass")]),s._v("等于20。")])]),s._v(" "),t("li",[t("p",[t("code",[s._v("startAddr")]),s._v("直接指向"),t("code",[s._v("arena")]),s._v("区域的某个位置，表示这个"),t("code",[s._v("mspan")]),s._v("的起始地址，"),t("code",[s._v("allocBits")]),s._v("指向一个位图，每位代表一个块是否被分配了对象；"),t("code",[s._v("allocCount")]),s._v("则表示总共已分配的对象个数。")])]),s._v(" "),t("li",[t("p",[s._v("这样，左起第一个"),t("code",[s._v("mspan")]),s._v("的各个字段参数就如下图所示：\n"),t("img",{attrs:{src:"https://raw.githubusercontent.com/hellolib/pictures/main/Typora/pic-00-gitee/20220617174230.jpg",alt:"img"}})])])]),s._v(" "),t("h2",{attrs:{id:"_3-内存管理组件"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-内存管理组件"}},[s._v("#")]),s._v(" 3. 内存管理组件")]),s._v(" "),t("ul",[t("li",[s._v("内存分配由"),t("a",{attrs:{href:"https://www.zhihu.com/search?q=%E5%86%85%E5%AD%98%E5%88%86%E9%85%8D%E5%99%A8&search_source=Entity&hybrid_search_source=Entity&hybrid_search_extra=%7B%22sourceType%22%3A%22article%22%2C%22sourceId%22%3A59125443%7D",target:"_blank",rel:"noopener noreferrer"}},[s._v("内存分配器"),t("OutboundLink")],1),s._v("完成。分配器由3种组件构成："),t("code",[s._v("mcache")]),s._v(", "),t("code",[s._v("mcentral")]),s._v(", "),t("code",[s._v("mheap")]),s._v("。")])]),s._v(" "),t("h3",{attrs:{id:"a-mcache"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#a-mcache"}},[s._v("#")]),s._v(" a. mcache")]),s._v(" "),t("ul",[t("li",[t("p",[t("code",[s._v("mcache")]),s._v("：每个工作线程都会绑定一个mcache，本地缓存可用的"),t("code",[s._v("mspan")]),s._v("资源，这样就可以直接给Goroutine分配，因为不存在多个Goroutine竞争的情况，所以不会消耗锁资源。")])]),s._v(" "),t("li",[t("p",[t("code",[s._v("mcache")]),s._v("的结构体定义：")]),s._v(" "),t("div",{staticClass:"language-go line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-go"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//path: /usr/local/go/src/runtime/mcache.go")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("type")]),s._v(" mcache "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("struct")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    alloc "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("numSpanClasses"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("mspan\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\nnumSpanClasses "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" _NumSizeClasses "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<<")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br")])])]),s._v(" "),t("li",[t("p",[t("code",[s._v("mcache")]),s._v("用"),t("code",[s._v("Span Classes")]),s._v("作为索引管理多个用于分配的"),t("code",[s._v("mspan")]),s._v("，它包含所有规格的"),t("code",[s._v("mspan")]),s._v("。它是"),t("code",[s._v("_NumSizeClasses")]),s._v("的2倍，也就是"),t("code",[s._v("67*2=134")]),s._v("，为什么有一个两倍的关系，前面我们提到过：为了加速之后内存回收的速度，数组里一半的"),t("code",[s._v("mspan")]),s._v("中分配的对象不包含指针，另一半则包含指针。")])]),s._v(" "),t("li",[t("p",[s._v("对于无指针对象的"),t("code",[s._v("mspan")]),s._v("在进行垃圾回收的时候无需进一步扫描它是否引用了其他活跃的对象。")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://raw.githubusercontent.com/hellolib/pictures/main/Typora/pic-00-gitee/20220617174504.jpg",alt:"img"}})])]),s._v(" "),t("li",[t("p",[t("code",[s._v("mcache")]),s._v("在初始化的时候是没有任何"),t("code",[s._v("mspan")]),s._v("资源的，在使用过程中会动态地从"),t("code",[s._v("mcentral")]),s._v("申请，之后会缓存下来。当对象小于等于32KB大小时，使用"),t("code",[s._v("mcache")]),s._v("的相应规格的"),t("code",[s._v("mspan")]),s._v("进行分配。")])])]),s._v(" "),t("h3",{attrs:{id:"b-mcentral"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#b-mcentral"}},[s._v("#")]),s._v(" b. mcentral")]),s._v(" "),t("ul",[t("li",[t("p",[t("code",[s._v("mcentral")]),s._v("：为所有"),t("code",[s._v("mcache")]),s._v("提供切分好的"),t("code",[s._v("mspan")]),s._v("资源。每个"),t("code",[s._v("central")]),s._v("保存一种特定大小的全局"),t("code",[s._v("mspan")]),s._v("列表，包括已分配出去的和未分配出去的。 每个"),t("code",[s._v("mcentral")]),s._v("对应一种"),t("code",[s._v("mspan")]),s._v("，而"),t("code",[s._v("mspan")]),s._v("的种类导致它分割的"),t("code",[s._v("object")]),s._v("大小不同。当工作线程的"),t("code",[s._v("mcache")]),s._v("中没有合适（也就是特定大小的）的"),t("code",[s._v("mspan")]),s._v("时就会从"),t("code",[s._v("mcentral")]),s._v("获取。")])]),s._v(" "),t("li",[t("p",[t("code",[s._v("mcentral")]),s._v("被所有的工作线程共同享有，存在多个Goroutine竞争的情况，因此会消耗锁资源。结构体定义：")]),s._v(" "),t("div",{staticClass:"language-go line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-go"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//path: /usr/local/go/src/runtime/mcentral.go")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("type")]),s._v(" mcentral "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("struct")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 互斥锁")]),s._v("\n    lock mutex \n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 规格")]),s._v("\n    sizeclass "),t("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("int32")]),s._v(" \n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 尚有空闲object的mspan链表")]),s._v("\n    nonempty mSpanList \n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 没有空闲object的mspan链表，或者是已被mcache取走的msapn链表")]),s._v("\n    empty mSpanList \n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 已累计分配的对象个数")]),s._v("\n    nmalloc "),t("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("uint64")]),s._v(" \n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br")])]),t("p",[t("img",{attrs:{src:"https://raw.githubusercontent.com/hellolib/pictures/main/Typora/pic-00-gitee/20220617174906.jpg",alt:"img"}})])]),s._v(" "),t("li",[t("p",[t("code",[s._v("empty")]),s._v("表示这条链表里的"),t("code",[s._v("mspan")]),s._v("都被分配了"),t("code",[s._v("object")]),s._v("，或者是已经被"),t("code",[s._v("cache")]),s._v("取走了的"),t("code",[s._v("mspan")]),s._v("，这个"),t("code",[s._v("mspan")]),s._v("就被那个工作线程独占了。而"),t("code",[s._v("nonempty")]),s._v("则表示有空闲对象的"),t("code",[s._v("mspan")]),s._v("列表。每个"),t("code",[s._v("central")]),s._v("结构体都在"),t("code",[s._v("mheap")]),s._v("中维护。")])]),s._v(" "),t("li",[t("p",[s._v("简单说下"),t("code",[s._v("mcache")]),s._v("从"),t("code",[s._v("mcentral")]),s._v("获取和归还"),t("code",[s._v("mspan")]),s._v("的流程：")]),s._v(" "),t("ul",[t("li",[t("p",[s._v("获取 加锁；从"),t("code",[s._v("nonempty")]),s._v("链表找到一个可用的"),t("code",[s._v("mspan")]),s._v("；并将其从"),t("code",[s._v("nonempty")]),s._v("链表删除；将取出的"),t("code",[s._v("mspan")]),s._v("加入到"),t("code",[s._v("empty")]),s._v("链表；将"),t("code",[s._v("mspan")]),s._v("返回给工作线程；解锁。")])]),s._v(" "),t("li",[t("p",[s._v("归还 加锁；将"),t("code",[s._v("mspan")]),s._v("从"),t("code",[s._v("empty")]),s._v("链表删除；将"),t("code",[s._v("mspan")]),s._v("加入到"),t("code",[s._v("nonempty")]),s._v("链表；解锁。")])])])])]),s._v(" "),t("h3",{attrs:{id:"c-mheap"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#c-mheap"}},[s._v("#")]),s._v(" c. mheap")]),s._v(" "),t("ul",[t("li",[t("p",[t("code",[s._v("mheap")]),s._v("：代表Go程序持有的所有堆空间，Go程序使用一个"),t("code",[s._v("mheap")]),s._v("的全局对象"),t("code",[s._v("_mheap")]),s._v("来管理堆内存。")])]),s._v(" "),t("li",[t("p",[s._v("当"),t("code",[s._v("mcentral")]),s._v("没有空闲的"),t("code",[s._v("mspan")]),s._v("时，会向"),t("code",[s._v("mheap")]),s._v("申请。而"),t("code",[s._v("mheap")]),s._v("没有资源时，会向操作系统申请新内存。"),t("code",[s._v("mheap")]),s._v("主要用于大对象的内存分配，以及管理未切割的"),t("code",[s._v("mspan")]),s._v("，用于给"),t("code",[s._v("mcentral")]),s._v("切割成小对象。")])]),s._v(" "),t("li",[t("p",[s._v("同时我们也看到，"),t("code",[s._v("mheap")]),s._v("中含有所有规格的"),t("code",[s._v("mcentral")]),s._v("，所以，当一个"),t("code",[s._v("mcache")]),s._v("从"),t("code",[s._v("mcentral")]),s._v("申请"),t("code",[s._v("mspan")]),s._v("时，只需要在独立的"),t("code",[s._v("mcentral")]),s._v("中使用锁，并不会影响申请其他规格的"),t("code",[s._v("mspan")]),s._v("。")])]),s._v(" "),t("li",[t("p",[t("code",[s._v("mheap")]),s._v("结构体定义：")]),s._v(" "),t("div",{staticClass:"language-go line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-go"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//path: /usr/local/go/src/runtime/mheap.go")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("type")]),s._v(" mheap "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("struct")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    lock mutex\n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// spans: 指向mspans区域，用于映射mspan和page的关系")]),s._v("\n    spans "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("mspan \n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 指向bitmap首地址，bitmap是从高地址向低地址增长的")]),s._v("\n    bitmap "),t("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("uintptr")]),s._v(" \n\n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 指示arena区首地址")]),s._v("\n    arena_start "),t("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("uintptr")]),s._v(" \n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 指示arena区已使用地址位置")]),s._v("\n    arena_used  "),t("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("uintptr")]),s._v(" \n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 指示arena区末地址")]),s._v("\n    arena_end   "),t("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("uintptr")]),s._v(" \n\n    central "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("67")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("struct")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        mcentral mcentral\n        pad "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("sys"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("CacheLineSize "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v(" unsafe"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("Sizeof")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("mcentral"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("%")]),s._v("sys"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("CacheLineSize"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("byte")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br")])]),t("p",[t("img",{attrs:{src:"https://raw.githubusercontent.com/hellolib/pictures/main/Typora/pic-00-gitee/20220617174622.jpg",alt:"img"}})])]),s._v(" "),t("li",[t("p",[s._v("上图我们看到，bitmap和arena_start指向了同一个地址，这是因为bitmap的地址是从高到低增长的，所以他们指向的内存位置相同。")])])]),s._v(" "),t("h2",{attrs:{id:"_7-分配流程"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_7-分配流程"}},[s._v("#")]),s._v(" 7. 分配流程")]),s._v(" "),t("ul",[t("li",[t("p",[s._v('变量是在栈上分配还是在堆上分配，是由逃逸分析的结果决定的。通常情况下，编译器是倾向于将变量分配到栈上的，因为它的开销小，最极端的就是"'),t("a",{attrs:{href:"https://www.zhihu.com/search?q=zero+garbage&search_source=Entity&hybrid_search_source=Entity&hybrid_search_extra=%7B%22sourceType%22%3A%22article%22%2C%22sourceId%22%3A59125443%7D",target:"_blank",rel:"noopener noreferrer"}},[s._v("zero garbage"),t("OutboundLink")],1),s._v('"，所有的变量都会在栈上分配，这样就不会存在内存碎片，垃圾回收之类的东西。')])]),s._v(" "),t("li",[t("p",[s._v("Go的内存分配器在分配对象时，根据对象的大小，分成三类：小对象（小于等于16B）、一般对象（大于16B，小于等于32KB）、大对象（大于32KB）。")])]),s._v(" "),t("li",[t("p",[s._v("大体上的分配流程：")]),s._v(" "),t("ul",[t("li",[t("p",[t("code",[s._v(">")]),s._v("32KB 的对象，直接从mheap上分配；")])]),s._v(" "),t("li",[t("p",[t("code",[s._v("<=")]),s._v("16B 的对象使用mcache的"),t("a",{attrs:{href:"https://www.zhihu.com/search?q=tiny%E5%88%86%E9%85%8D%E5%99%A8&search_source=Entity&hybrid_search_source=Entity&hybrid_search_extra=%7B%22sourceType%22%3A%22article%22%2C%22sourceId%22%3A59125443%7D",target:"_blank",rel:"noopener noreferrer"}},[s._v("tiny分配器"),t("OutboundLink")],1),s._v("分配；")])]),s._v(" "),t("li",[t("p",[s._v("(16B,32KB] 的对象，首先计算对象的规格大小，然后使用mcache中相应规格大小的mspan分配；")]),s._v(" "),t("ul",[t("li",[s._v("如果mcache没有相应规格大小的mspan，则向mcentral申请")]),s._v(" "),t("li",[s._v("如果mcentral没有相应规格大小的mspan，则向mheap申请")]),s._v(" "),t("li",[s._v("如果mheap中也没有合适大小的mspan，则向操作系统申请")])])])])])]),s._v(" "),t("h2",{attrs:{id:"_8-总结"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_8-总结"}},[s._v("#")]),s._v(" 8. 总结")]),s._v(" "),t("ul",[t("li",[t("p",[s._v("Go语言的内存分配非常复杂，它的一个原则就是能复用的一定要复用。一般而言，了解它的原理，到这个程度也可以了。")]),s._v(" "),t("ul",[t("li",[t("p",[s._v("Go在程序启动时，会向操作系统申请一大块内存，之后自行管理。")])]),s._v(" "),t("li",[t("p",[s._v("Go内存管理的基本单元是mspan，它由若干个页组成，每种mspan可以分配特定大小的object。")])]),s._v(" "),t("li",[t("p",[s._v("mcache, mcentral, mheap是Go内存管理的三大组件，层层递进。mcache管理线程在本地缓存的mspan；mcentral管理全局的mspan供所有线程使用；mheap管理Go的所有动态分配内存。")])]),s._v(" "),t("li",[t("p",[s._v("极小对象会分配在一个object中，以节省资源，使用tiny分配器分配内存；一般小对象通过mspan分配内存；大对象则直接由mheap分配内存。")])])])])])])}),[],!1,null,null,null);t.default=e.exports}}]);